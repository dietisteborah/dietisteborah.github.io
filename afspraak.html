<!DOCTYPE html>
<html>
  <head>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-118437837-1"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'UA-118437837-1');
	</script>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS & Javascript-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
	<!-- icon library -->
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.10/css/all.css" integrity="sha384-+d0P83n9kaQMCwj8F4RJB66tzIwOKmrdb46+porD/OvrJ+37WqIM7UoBtwHO6Nlg" crossorigin="anonymous">
	<!-- CSS adjustments -->
	<link rel="stylesheet" type="text/css" href="customcss/custom.css">
	<!-- Google Fonts -->
	<link href='https://fonts.googleapis.com/css?family=Sofia' rel='stylesheet'>
	<link href='https://fonts.googleapis.com/css?family=Khula' rel='stylesheet'>
	<link href='https://fonts.googleapis.com/css?family=Amaranth' rel='stylesheet'>
	<link href='https://fonts.googleapis.com/css?family=Alegreya Sans SC' rel='stylesheet'>	
	
	<!-- jquery -->
	<!--<script type="text/javascript" src="jquery.js"></script>-->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

	<!-- hello week -->
	<script src="/node_modules/hello-week/dist/helloweek.min.js"></script>
	<link rel="stylesheet" type="text/css" href="/node_modules/hello-week/dist/helloweek.min.css">
	
    <title>Afspraak - Dietiste Borah Van Doorslaer</title>
	
  </head>
 
<body>
	<div id="header">
	</div>	
	<div class="container" id="afspraken_container">
		<!-- Terugbetaling -->
		<h1 class="brown_text custom_header top-buffer no-bottom-buffer" align="left">Een afspraak maken</h1>
		<br>
		<div class="row brown_text top-buffer-10" id="kalender">
				<div class="hello-week col-md-5">
					<h2 class="custom_header_small" align="left" style="white-space:nowrap;">Kies een datum:</h2>			
					<div class="hello-week__header padding_small">
						<button class="hello-week__prev controle_button orange_text font_Khula bold_text">Vorige</button>
						<div class="hello-week__label" id="week_year"></div>
						<button class="hello-week__next controle_button orange_text font_Khula bold_text">Volgende</button>
					</div>
					<div class="hello-week__week"></div>
					<div class="hello-week__month"></div>
					<br>

				</div>	
				<div class="custom-hello-week col-md-3">
					<div class="radio" style="white-space:nowrap overflow:hidden">
						<ul style="padding-left: 0px !important">
						<li><h2 class="custom_header_small" align="left">Kies je consultatie: </h2></li>
						<li><label class="radio-inline orange_text font_Khula bold_text"><input type="radio" name="optradio" checked="checked" value="start"> Eerste consultatie</label></li>
						<li><label class="radio-inline orange_text font_Khula bold_text"><input type="radio" name="optradio" value="opvolg"> Opvolgconsultatie</label></li>
					</div>
					<h2 class="custom_header_small" align="left">Kies een tijdstip:</h2> 
					<ul class="available-hours" id="timeList" style="padding-left: 20px !important"><table>*zoeken*</tr></table> 
				</div>	
				<div class="custom-hello-week col-md-4" style="padding-left: 20px !important">
					<h2 class="custom_header_small" align="left">Persoonlijke gegevens:</h2> 
					<a class="orange_text font_Khula bold_text">Voor & achternaam: </a>*<br>
					<input id="name" type="text" name="naam" class="input_box">
					<br>
					<a class="orange_text font_Khula bold_text">E-mail: </a>*<br>
					<input id="email" type="email" name="email" autocomplete="on" class="input_box">
					<br>
					<a class="orange_text font_Khula bold_text">Telefoon: </a>*<br>
					<input id="phone" type="text" name="phone" class="input_box">
					<br>
					<a class="orange_text font_Khula bold_text">Opmerkingen of vragen:</a><br>
					<TEXTAREA id="remark" name="opmerkingen" rows="5" class="input_box_large " placeholder="Gelieve kort te vermelden welk voedingsadvies je wenst"></TEXTAREA>
					<br>
					<ul class="left">
					<li><button class="controle_button orange_text font_Khula" onclick="bevestig()">Bevestig</button><br></li>
					<li><a class="small_note brown_text font_Khula">Velden met een * zijn verplicht. </a></li>
					</ul>
				</div>	
			</div>
	</div>
	<div id="footer">
	</div>
</body>
<script>
	$(function(){
		$("#header").load("navbar.html");
	});
	$(function(){
		$("#footer").load("footer.html");
	});
	$(document).ready(function(){
		setTimeout(function(){
			vrijeAfspraak();
			highlightfreedays(document.getElementById('week_year').innerHTML);
		}, 200);
		
	});	
	//update functie
	const availablehours = document.querySelector('.available-hours');
	//global variables
	var selected_Time = 'Geen';
	var selected_Day = '';
	var appointment_Type = "start";
	var previousId = "";
	$("input[name='optradio']").on("change", function () {
	   appointment_Type = this.value;
	   updateInfo();
	});
	
	function updateInfo() {
		if (this.lastSelectedDay || selected_Day !="") {
			var phpfile = 'afspraken_backend.php';
			if(this.lastSelectedDay){ //only change the date if someone clicked other date (and not just changed type)
				selected_Day = this.lastSelectedDay;
			}
			selected_Time = "";
			data =  {'action': 'getAvailable',
					  'date' : selected_Day,
					  'opvolg' : appointment_Type};	
			$.post(phpfile, data, function (response) {	
				//remove all previous found hours from previous selected day
				while (document.getElementById("timeList").firstChild) {
					document.getElementById("timeList").removeChild(document.getElementById("timeList").firstChild);
				}
				var list = response.split(";");	
				var node = '';		
				var rowcounter = 0;
				if(list.length==1){
					node = node + '<td><a class=\'brown_text\'>' + "Geen afspraken beschikbaar op deze datum." + '</a></td>';
				}
				else{
					list.forEach(function(entry){
						if(rowcounter==0){
							node = node + '<tr>';
						}
						if(entry!=""){					
							node = node + '<td><button class=\'brown_text not_clicked\' id=' + entry + ' onClick=\"select_hour(this.id)\"' + '>' + entry + '</button></td>';
						}	
						//layout of the list
						if(rowcounter==2){
							rowcounter=0;
							node = node + '</tr>'; 
						}
						else{
							rowcounter = rowcounter + 1;
						}					
					});
				}
				$('#timeList').html(node);
			});

		}
	}
	function updateInfoSelectedDayKnown() {
		var phpfile = 'afspraken_backend.php';
		selected_Time = "";
		data =  {'action': 'getAvailable',
				  'date' : selected_Day,
				  'opvolg' : appointment_Type};	
		$.post(phpfile, data, function (response) {	
			//remove all previous found hours from previous selected day
			while (document.getElementById("timeList").firstChild) {
				document.getElementById("timeList").removeChild(document.getElementById("timeList").firstChild);
			}
			var list = response.split(";");	
			var node = '';		
			var rowcounter = 0;
			if(list.length==1){
				node = node + '<td><a class=\'brown_text\'>' + "Geen afspraken beschikbaar op deze datum." + '</a></td>';
			}
			else{
				list.forEach(function(entry){
					if(rowcounter==0){
						node = node + '<tr>';
					}
					if(entry!=""){					
						node = node + '<td><button class=\'brown_text not_clicked\' id=' + entry + ' onClick=\"select_hour(this.id)\"' + '>' + entry + '</button></td>';
					}	
					//layout of the list
					if(rowcounter==2){
						rowcounter=0;
						node = node + '</tr>'; 
					}
					else{
						rowcounter = rowcounter + 1;
					}					
				});
			}
			$('#timeList').html(node);
		});
	}
	function bevestig(){
			//get all values 		
			var name = document.getElementById("name").value;
			var email = document.getElementById("email").value;
			var phone = document.getElementById("phone").value;
			var remark = document.getElementById("remark").value;
			
			if(selected_Time==""){
				alert("Gelieve een tijdstip te selecteren.");
			}
			else{
				//call php function
				var phpfile = 'afspraken_backend.php';	
				data =  {'action': 'createAppointment',
						  'date' : selected_Day,
						  'time' : selected_Time,
						  'name' : name,
						  'email' : email,
						  'phone' : phone,
						  'remark' : remark,
						  'type' : appointment_Type};
				$.post(phpfile, data, function (response) {
					if(response.includes("Gelieve")){
						alert(response);
					}
					else{
						while (document.getElementById("kalender").firstChild) {
							document.getElementById("kalender").removeChild(document.getElementById("kalender").firstChild);
						}
						$('#afspraken_container').html(response);
					}
				});		
			}
			//updateInfo(); //TODO
	}
	function select_hour(clicked_id){
		if(clicked_id != "geen"){
			/*
				update selected_Time
			*/
			selected_Time = clicked_id;
			document.getElementById(clicked_id).setAttribute("class","clicked_button");
			if(previousId != "" && previousId != clicked_id){
				document.getElementById(previousId).setAttribute("class","brown_text not_clicked");
			}
			previousId = clicked_id;
		}		
	}
	function loadToday() {
		var phpfile = 'afspraken_backend.php';
		selected_Day = this.getToday('YYYY-MM-DD');
		selected_Time = "";
		data =  {'action': 'loadToday',
				  'date' : selected_Day};
		$.post(phpfile, data, function (response) {
			availablehours.innerHTML = '';
			var li = document.createElement('li');
			li.innerHTML = response;
			availablehours.appendChild(li);
		});
	}
	function highlightfreedays(){
		var phpfile = 'afspraken_backend.php';
		data =  {'action': 'highlightfreedays',
				  'month_year' : document.getElementById('week_year').innerHTML,
				  'type' : appointment_Type};
		$.post(phpfile, data, function (response) {
			if(response==""){
				//disable all appointments
				var x = document.getElementsByClassName("hello-week__day");
				for (j = 1; j <= x.length; j++) {
					x[j-1].classList.add('is-disabled');
				}
			}
			else{
				//disable everything
				var x = document.getElementsByClassName("hello-week__day");
				for (j = 1; j <= x.length; j++) {
					x[j-1].classList.add('is-disabled');
					x[j-1].classList.remove('is-selected');
				}
				var dataArray = response.split(",");
				var arrayLength = dataArray.length;
				var first = true;
				for (var i = 0; i < arrayLength; i++) {
					var j;
					for (j = 0; j < x.length; j++) {
						if(j==parseInt(dataArray[i].substr(8,2))){
							if(first){
								x[j-1].classList.add('is-selected');
								first = false;
								selected_Day = dataArray[i];
								updateInfoSelectedDayKnown();
							}
							x[j-1].classList.remove('is-disabled');
							x[j-1].classList.remove('is-weekend');
							x[j-1].classList.add('is_free');
						}
					}
				}
			}				
		});
	}
	//hello week init
	const myCalendar = new HelloWeek({
		selector: '.hello-week',
		lang: 'nl',
		langFolder: './node_modules/hello-week/dist/langs/',
		format: 'YYYY-MM-DD',
		weekShort: true,
		monthShort: false,
		multiplePick: false,
		defaultDate: false,
		todayHighlight: true,
		disablePastDays: true,
		disabledDaysOfWeek: false,
		disableDates: false,
		weekStart: 1,
		daysHighlight: false,
		range: false,
		minDate: false,
		maxDate: false,
        onLoad: loadToday,
        onChange: highlightfreedays,
        onSelect: updateInfo,
		onClear: () => { /** callback function */ }
	});
	function vrijeAfspraak() {
		var previous_selected_Day = selected_Day;
		myCalendar.today();
		selected_Day = myCalendar.getToday('YYYY-MM-DD');
		
		//functie die vrije dag geeft vanuit PHP database
		var firstfreeday = "Error";
		//call php function
		var phpfile = 'afspraken_backend.php';	
		data =  {'action': 'freeAppointment',
				  'type' : appointment_Type};
		$.post(phpfile, data, function (response) {
			firstfreeday = response;
			if(firstfreeday != ""){
				var freeMonth = parseInt(firstfreeday.substr(5,2));
				var currentMonth = parseInt(selected_Day.substr(5,2));
				var monthDifference = freeMonth-currentMonth;
				
				if(monthDifference > 0){
					//go to next month
					for(var i=0;i<monthDifference;i++){
						myCalendar.next();
					}
					//set new day active
					var x = document.getElementsByClassName("hello-week__day");
					var i;
					//remove all "is-selected"
					for (i = 0; i < x.length; i++) {
						x[i].classList.remove('is-selected');
					}
					for (i = 0; i < x.length; i++) {
						if(i==parseInt(firstfreeday.substr(8,2))){
							x[i-1].classList.add('is-selected');
						}
					}
					selected_Day = firstfreeday;
				}
				else if(monthDifference == 0){
					var x = document.getElementsByClassName("hello-week__day");
					var i;
					for (i = 0; i < x.length; i++) {
						if(i==parseInt(previous_selected_Day.substr(8,2))){
							x[i-1].classList.remove('is-selected');
						}
						if(i==parseInt(firstfreeday.substr(8,2))){
							x[i-1].classList.add('is-selected');
						}
					}	
					selected_Day = firstfreeday;			
				}
				updateInfoSelectedDayKnown();
			}
			else{
				availablehours.innerHTML = '';
				var li = document.createElement('li');
				li.innerHTML = "Momenteel geen afspraken beschikbaar. Gelieve me te contacteren op: <br>  +32 485 36 04 09 <br>  of <br> dietiste.borah@gmail.com.";
				availablehours.appendChild(li);
			}
		});		
	}
</script>
</html>